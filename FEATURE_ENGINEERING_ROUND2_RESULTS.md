# 特徴量エンジニアリング Round 2 結果

**実施日**: 2025-10-21
**目的**: 9特徴量ベースライン（OOF 0.8384, LB 0.77751）の改善

---

## 📊 評価した特徴量

### 評価1: Sex×Pclass交互作用

**仮説**: 1等女性（生存率96%）と3等男性（生存率14%）の差を明示的に学習

**結果**:
- OOF Score: **0.8361** (-0.23%)
- ベースライン: 0.8384
- **判定**: ❌ **不採用**

**原因**:
- SexとPclassは既にモデルに含まれている
- ツリーベースモデル（RF, GB, LightGBM）は自動的に交互作用を学習
- 明示的な交互作用特徴量は冗長で多重共線性を引き起こす
- VIF: 全特徴量で999999（完全多重共線性）

**教訓**: ツリーベースモデルでは明示的な交互作用特徴量は不要

---

### 評価2: シンプルな新特徴量（3種類）

| 特徴量 | OOF Score | OOF改善 | 判定 |
|--------|-----------|---------|------|
| **ベースライン** | **0.8384** | - | - |
| **+IsAlone** | **0.8395** | **+0.0011** | ✅ **採用候補** |
| +FarePerPerson | 0.8350 | -0.0034 | ❌ 不採用 |
| +AgeGroup | 0.8384 | ±0.0000 | ❌ 不採用 |

---

## ✅ 最良の特徴量: IsAlone

### 特徴量定義

```python
# 単独乗船フラグ
df['IsAlone'] = (df['FamilySize'] == 1).astype(int)
```

### 性能

- **OOF Score**: 0.8395
- **ベースライン比**: +0.0011 (+0.11%)
- **特徴量数**: 10 → 11

### 理論的根拠

**単独乗船者の特性**:
- 家族がいない → 助け合いがない
- 生存率が低い傾向
- FamilySizeからは得られない二値的なシグナル

**Train データでの検証**:

```python
# 単独乗船 vs グループ乗船の生存率
train.groupby('IsAlone')['Survived'].mean()
```

予想される結果:
- IsAlone=1（単独）: 生存率 30-35%
- IsAlone=0（グループ）: 生存率 50-55%

### OOF改善の解釈

**+0.11%は小さいが意味がある**:
- 891人中 約1人の予測が改善
- LBでも同様の改善なら +0.00077 → LB 0.77828
- 小さいが正の効果

### 期待LB Score

**保守的予測**:
- Gap 6.09%を仮定: 0.8395 - 0.0609 = **0.7786**
- ベースラインLB: 0.77751
- **期待改善**: +0.00109

**実際の結果次第で判断**:
- LB > 0.7776: 採用 ✅
- LB ≈ 0.7775: 効果なし（採用見送り）
- LB < 0.7775: 悪影響（不採用）

---

## ❌ 不採用となった特徴量

### FarePerPerson（1人当たり運賃）

**定義**:
```python
df['FarePerPerson'] = df['Fare'] / df['FamilySize']
```

**結果**:
- OOF Score: 0.8350 (-0.34%)
- **判定**: ❌ **OOF悪化のため不採用**

**原因分析**:
- FareとFamilySizeは既に含まれている
- モデルが自動的に比率を学習している可能性
- 明示的な比率特徴は冗長

---

### AgeGroup（年齢グループ）

**定義**:
```python
# 0: Child (<16), 1: YoungAdult (16-30),
# 2: Adult (30-60), 3: Senior (60+)
df['AgeGroup'] = ...
```

**結果**:
- OOF Score: 0.8384 (±0.00%)
- **判定**: ❌ **効果なしのため不採用**

**原因分析**:
- Age（連続値）が既に含まれている
- ツリーベースモデルは自動的に年齢の閾値を学習
- グループ化は情報を失うだけ

---

## 📋 特徴量エンジニアリング総括

### 成功事例

1. **IsAlone**: OOF +0.11% ✅
   - シンプルで独立
   - 二値的なシグナル
   - FamilySizeと補完関係

### 失敗事例

1. **Sex×Pclass交互作用**: OOF -0.23% ❌
   - ツリーベースモデルには不要
   - 多重共線性

2. **FarePerPerson**: OOF -0.34% ❌
   - 既存特徴量から自動学習可能
   - 冗長

3. **AgeGroup**: OOF ±0.00% ❌
   - 連続値Ageの方が情報量大
   - グループ化は劣化

---

## 🎓 学んだ教訓

### ✅ 有効な特徴量の条件

1. **シンプルで独立**
   - IsAloneは単純な二値特徴
   - 他の特徴量と独立

2. **新しい情報を提供**
   - FamilySizeだけでは得られない「単独 vs グループ」の区別
   - 二値化による明確なシグナル

3. **理論的根拠が明確**
   - 単独乗船者は助け合いがない → 生存率低下
   - ドメイン知識に基づく

### ❌ 無効な特徴量の特徴

1. **ツリーモデルで自動学習される**
   - 交互作用（Sex×Pclass）
   - 比率（FarePerPerson）
   - グループ化（AgeGroup）

2. **既存特徴量の線形結合**
   - 多重共線性を引き起こす
   - VIF > 10

3. **情報を失う変換**
   - 連続値 → カテゴリ（Age → AgeGroup）
   - 精度低下

---

## 🚀 次のステップ

### 即座のアクション

**Kaggle LB検証**:
- 提出ファイル: `submission_isalone_added.csv`
- 期待LB: 0.7786 (保守的), 0.7780 (楽観的)
- 判断基準: LB > 0.77751 → 採用

### LB結果に応じた対応

**シナリオA: LB > 0.7780**
- ✅ IsAlone採用
- ✅ 他のシンプル特徴量も検討（Title詳細化等）

**シナリオB: LB 0.7775-0.7780**
- ⚠️ 微改善 → 一旦保留
- 他の改善（CV戦略）を優先

**シナリオC: LB < 0.7775**
- ❌ IsAlone不採用
- Deck_Safeの二の舞（OOF改善、LB悪化）
- CV戦略改善（Stratified Group K-Fold）へ移行

---

## 📊 現在のモデル状態

### ベストモデル（LB検証前）

**モデル**: 9特徴量 Hard Voting
- **LB Score**: 0.77751（確定）
- **OOF Score**: 0.8384
- **Gap**: 6.09%

**特徴量（10個）**:
1. Pclass
2. Sex
3. Age
4. SibSp
5. Parch
6. Fare
7. Title
8. FamilySize
9. Embarked_Q
10. Embarked_S

### 候補モデル（LB検証待ち）

**モデル**: 10特徴量 + IsAlone Hard Voting
- **LB Score**: ???（検証待ち）
- **OOF Score**: 0.8395
- **期待Gap**: 6.09%
- **期待LB**: 0.7786

**追加特徴量**: IsAlone

---

## 🎯 目標と進捗

### 短期目標

| 目標 | 現状 | 進捗 |
|------|------|------|
| LB 0.78以上 | 0.77751 | ⚠️ あと+0.25% |
| OOF改善特徴量発見 | IsAlone (+0.11%) | ✅ 発見 |
| LB検証実施 | 未実施 | ⏳ 次のステップ |
| Gap 3%以下 | 6.09% | ❌ 未達成 |

### 中期目標

**LB 0.80以上**:
- 特徴量改善だけでは困難
- CV戦略改善（Stratified Group K-Fold）必須
- Stacking等の高度なアンサンブル検討

---

## 📝 推奨される次のアクション

### Priority 1: IsAlone のLB検証

**提出**: `submission_isalone_added.csv`
**期待**: LB > 0.77751
**判断**: 結果次第で採用決定

### Priority 2（IsAlone成功時）: 他のシンプル特徴量

**候補**:
- Title の詳細化（Rare titles のグループ化改善）
- Cabin の有無（Cabin_Known binary flag）
- Parch×SibSp の組み合わせ（両親のみ、子供のみ等）

**評価**: 1つずつ追加 → OOF確認 → **LB検証必須**

### Priority 3（IsAlone失敗時）: CV戦略改善

**実装**: Stratified Group K-Fold
**目的**: Gap 6.09% → 3%以下
**効果**: より正確なOOF評価

---

## まとめ

### 達成したこと

1. ✅ 4種類の新特徴量を評価
2. ✅ IsAlone特徴量を発見（OOF +0.11%）
3. ✅ ツリーモデルでの特徴量エンジニアリングのベストプラクティスを学習

### 次のマイルストーン

1. **IsAlone のLB検証**（最優先）
2. 結果に応じた戦略決定:
   - 成功 → 特徴量改善継続
   - 失敗 → CV戦略改善へ転換

### 最終目標

- **短期**: LB 0.78以上
- **中期**: LB 0.80以上（上位10%）

---

**作成日**: 2025-10-21
**次のアクション**: `submission_isalone_added.csv` をKaggle LBで検証
