# アンサンブル多様性分析と4モデルアンサンブル

**日付**: 2025-10-24
**目的**: SVM_RBFをアンサンブルに追加する効果を検証

## 背景

### 5th提出結果（SVM_RBF単体）
- **LB Score**: 0.77511
- **CV Score**: 0.8316（過去最高）
- **Gap**: 6.78%（最悪）
- **結果**: 4th提出（0.78468）から -0.00957 大幅悪化

### 重要な教訓
- **OOF最高 → LB最低** という極端な乖離
- OOFが高い ≠ LBが高い（最も顕著な例）
- 単一モデル（SVM）< アンサンブル（Soft Voting）

### 仮説
SVM_RBFは単体では失敗したが、アンサンブルに追加することで：
- 予測の多様性を増やす
- アンサンブル全体の精度を向上させる可能性

## 実験内容

### モデル構成

**3モデル（4th提出）**:
1. LightGBM (AgeGroup使用)
2. GradientBoosting (AgeGroup使用)
3. RandomForest (Age使用)

**4モデル（新規）**:
1. LightGBM (AgeGroup使用)
2. GradientBoosting (AgeGroup使用)
3. RandomForest (Age使用)
4. SVM_RBF (Age使用) ← 追加

### 評価方法
- Cross-Validation: 5-Fold Stratified K-Fold
- 評価指標: OOF Accuracy
- モデル間相関分析
- アンサンブル効果の測定

## 結果

### 1. 各モデルのOOF Score

| モデル | OOF Score |
|--------|-----------|
| LightGBM | 0.8182 |
| GradientBoosting | 0.8339 |
| RandomForest | 0.8339 |
| SVM_RBF | 0.8316 |

### 2. モデル間の相関分析

#### 相関行列

```
                  LightGBM  GradientBoosting  RandomForest  SVM_RBF
LightGBM          1.0000    0.8728            0.9310        0.9211
GradientBoosting  0.8728    1.0000            0.9119        0.8922
RandomForest      0.9310    0.9119            1.0000        0.9654
SVM_RBF           0.9211    0.8922            0.9654        1.0000
```

#### モデル間相関（ペア別、多様性順）

| モデル1 | モデル2 | 相関 | 多様性 |
|---------|---------|------|--------|
| LightGBM | GradientBoosting | 0.8728 | **0.1272** ⭐ 最高 |
| GradientBoosting | SVM_RBF | 0.8922 | 0.1078 |
| GradientBoosting | RandomForest | 0.9119 | 0.0881 |
| LightGBM | SVM_RBF | 0.9211 | 0.0789 |
| LightGBM | RandomForest | 0.9310 | 0.0690 |
| **RandomForest** | **SVM_RBF** | **0.9654** | **0.0346** ❌ 最低 |

#### 多様性分析

**3モデル（LGB + GB + RF）**:
- 平均相関: 0.9052
- 平均多様性: **0.0948**

**SVM関連（SVM vs 他3モデル）**:
- 平均相関: 0.9262
- 平均多様性: **0.0738**

**SVM追加の効果**:
- 多様性変化: **-0.0210** ❌
- **結論**: SVMは3モデルより予測が似ている（多様性が減少）

### 3. アンサンブル評価

| アンサンブル | OOF Score | 改善 |
|--------------|-----------|------|
| 3モデル Soft Voting | 0.8294 | - |
| **4モデル Soft Voting** | **0.8316** | **+0.0022** |

### 4. 期待LB予測

**4th提出実績**:
- OOF: 0.8249
- LB: 0.78468
- Gap: 4.88%

**4モデルアンサンブル期待値（Gap 4.88%仮定）**:
- OOF: 0.8316
- **期待LB**: **0.79110**
- **改善**: **+0.00642** (vs 4th提出)
- 目標0.80まで: 残り **+0.00890**

## 考察

### うまくいった点

1. **OOFスコアの微増**: +0.0022
   - わずかながら改善が確認された
   - SVMの追加が完全に無駄ではない

2. **アンサンブル効果の確認**:
   - 4モデルSoft Votingが3モデルを上回る
   - 期待LB改善: +0.00642

### うまくいかなかった点

1. **多様性の減少**: -0.0210
   - SVMはRFと非常に似た予測（相関0.9654）
   - 期待に反して多様性が減少

2. **SVM単体のGap問題**: 6.78%
   - 4thのGap（3.9%）より大きい
   - アンサンブル全体のGapを悪化させる可能性

3. **改善幅の限定性**:
   - OOF改善は +0.0022（小さい）
   - 目標0.80には依然として届かない（残り+0.00890）

### 学んだこと

1. **相関の重要性**:
   - RandomForest vs SVM: 相関0.9654 → 多様性ほぼゼロ
   - 似た予測をするモデルを追加しても効果薄い

2. **OOF-LB Gapの警告**:
   - SVMのGap（6.78%）が大きい
   - アンサンブルに加えるとGap悪化のリスク

3. **多様性 ≠ モデル数**:
   - モデルを増やせば良いわけではない
   - 異なるアーキテクチャでも予測が似る場合がある

## 結論

### ✅ 4モデルアンサンブルの価値

**潜在的メリット**:
- OOF改善: +0.0022
- 期待LB改善: +0.00642
- 目標0.80に近づく（残り+0.00890）

**懸念点**:
- SVMのGap（6.78%）が4thのGap（3.9%）より大きい
- RF vs SVM の相関が非常に高い（0.9654）
- 多様性が減少（-0.0210）
- アンサンブル全体のGapが悪化する可能性

### 📝 推奨

**明日の提出枠復活後**:
1. **4モデルアンサンブルを試す価値はある**
   - 期待LB改善: +0.00642
   - ただしリスクを理解した上で

2. **代替案: より多様なモデル**
   - SVMのハイパーパラメータ調整（C, gamma）
   - 異なるカーネル（linear, poly）
   - ニューラルネットワーク（全く異なるアーキテクチャ）

3. **保守的アプローチ**:
   - 4th提出（0.78468）を維持
   - より確実な改善策を模索

## 生成ファイル

1. **多様性分析スクリプト**: `scripts/analysis/ensemble_diversity_analysis.py`
2. **4モデルアンサンブル**: `scripts/models/4model_ensemble_submission.py`
3. **提出ファイル**: `submissions/submission_4model_ensemble_soft_voting.csv`
   - OOF: 0.8316
   - 期待LB: 0.79110 (+0.00642)
4. **ドキュメント**: `experiments/logs/20251024_ensemble_diversity_analysis.md`（本ファイル）

---

**最終更新**: 2025-10-24
**作成者**: Claude Code
